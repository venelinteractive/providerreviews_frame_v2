version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        - npm install sharp
        # Validate environment variables
        - |
          if [ -z "$API_URL" ] || [ -z "$API_KEY" ] || [ -z "$REVALIDATE_SECRET" ]; then
            echo "Missing required environment variables"
            exit 1
          fi
    build:
      commands:
        - env | grep -e API_URL -e API_KEY -e REVALIDATE_SECRET >> .env.production
        - export NODE_OPTIONS="--max-old-space-size=8192"
        - npm run build
        # Prepare standalone build
        - node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json')); pkg.dependencies=pkg.dependencies||{}; pkg.dependencies['sharp']=pkg.dependencies['sharp']||'*'; fs.writeFileSync('package.json', JSON.stringify(pkg));"
        # Ensure all necessary files are copied
        - cp -r .next/static .next/standalone/.next/
        - cp -r public .next/standalone/
        - cp .env.production .next/standalone/
  artifacts:
    baseDirectory: .next/standalone
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
